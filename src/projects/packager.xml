<?xml version="1.0" encoding="UTF-8"?>
<project name="Packager" default="build">

    <!-- Create New Release and package -->
    <target name="build-new" description="Update version/creation and create IDed package" depends="prompt-new-version">
        <if>
            <isset property="release.type"/>
            <then>
                <setversion releasetype="${release.type}" file="${project.manifest}" property="manifest.version" customvalue="${release.custom_version}"/>
                <phingcall target="update-creation"/>

                <!-- Update the version for related extensions which are not on this repo, but still set to update -->
                <foreach list="${project.relatedExtensions}" param="extension" target="set-version-related-extensions" delimiter="," />

                <phingcall target="package">
                    <property name="package.file" value="${project.name.long}_${composer.extra.package-license}_${manifest.version}.zip"/>
                </phingcall>
            </then>
        </if>
    </target>

    <!-- Get version number without build -->
    <target name="version" description="Get the version from the current source">
        <echo>Current version: ${manifest.version}</echo>
        <echo>Creation date: ${manifest.creationDate}</echo>
    </target>

    <!-- Update version number without build -->
    <target name="set-version" description="Update version/creation and create IDed package" depends="prompt-new-version">
        <if>
            <isset property="release.type"/>
            <then>
                <setversion releasetype="${release.type}" file="${project.manifest}" property="manifest.version" customvalue="${release.custom_version}"/>
                <phingcall target="update-creation"/>

                <!-- Update the version for related extensions which are not on this repo, but still set to update -->
                <foreach list="${project.relatedExtensions}" param="extension" target="set-version-related-extensions" delimiter="," />
            </then>
        </if>
    </target>

    <!-- Create New Release and package for development -->
    <target name="build-dev" description="Update version/creation and create IDed package with alpha number">
        <property name="release.type" value="ALPHA" override="true"/>
        <setversion releasetype="${release.type}" file="${project.manifest}" property="manifest.version" customvalue="${release.custom_version}"/>
        <phingcall target="update-creation"/>

        <phingcall target="package">
            <property name="package.file" value="${project.name.long}_${composer.extra.package-license}_${manifest.version}.zip"/>
        </phingcall>
    </target>

    <!-- Create Current Release and package -->
    <target name="build" description="Generate package file for current version">
        <property name="manifest.version" value="0.0.0" override="false"/>
        <phingcall target="package">
            <property name="package.file" value="${project.name.long}_${composer.extra.package-license}_${manifest.version}.zip"/>
        </phingcall>
    </target>

    <!-- Set the version for the extension into a project -->
    <target name="set-version-related-extensions" hidden="true">
        <echo>set-version-related-extensions-${extension}</echo>
        <if>
            <not>
                <contains string="${extension}" substring="${"/>
            </not>
            <then>
                <echo>Updating version for: ${extension}</echo>

                <!-- Related extensions which only exists in the free version, will be only found at the tmp folder -->
                <if>
                    <available file="${project.source.path}/extensions/${extension}" type="dir"/>
                    <then>
                        <property name="extensions.path" value="${project.source.path}/extensions" override="true"/>
                    </then>
                    <else>
                        <property name="extensions.path" value="${packages.tmp.path}/extensions" override="true"/>
                    </else>
                </if>

                <!-- Do we have this extension pre-packed? -->
                <if>
                    <available file="${extensions.path}/${extension}" type="dir" />
                    <then>
                        <!-- Look for the manifest file of this internal extension -->
                        <property name="extension.manifest" value="${extensions.path}/${extension}/${project.relatedExtensions.${extension}.element}.xml"/>
                        <if>
                            <available file="${extension.manifest}"/>
                            <then/>
                            <else>
                                <!-- Look for the manifest file of this internal extension (fallback for modules) -->
                                <property name="extension.manifest" value="${extensions.path}/${extension}/mod_${project.relatedExtensions.${extension}.element}.xml" override="true"/>
                                <if>
                                    <available file="${extension.manifest}"/>
                                    <then/>
                                    <else>
                                        <echo level= "warning">Manifest file not found: ${extension.manifest}</echo>
                                    </else>
                                </if>
                            </else>
                        </if>
                    </then>
                </if>

                <if>
                    <available file="${extension.manifest}"/>
                    <then>
                        <setversion releasetype="custom" file="${extension.manifest}" property="extension.version" customvalue="${manifest.version}"/>
                        <phingcall target="update-creation">
                            <property name="project.manifest" value="${extension.manifest}"/>
                        </phingcall>
                    </then>
                </if>
            </then>
        </if>
    </target>

    <!-- Pack the extension into a project -->
    <target name="pack-related-extensions">
        <if>
            <not>
                <contains string="${extension}" substring="${"/>
            </not>
            <then>
                <echo>Packing the related extension: ${extension}</echo>

                <property name="extensions.tmp.path" value="${packages.tmp.path}/extensions"/>

                <!-- Do we have this extension pre-packed? -->
                <if>
                    <available file="${extensions.tmp.path}/${extension}" type="dir" />
                    <then>
                        <echo>The extension ${extension} is pre-packed. Ignoring...</echo>
                    </then>
                    <else>
                        <!-- Is the extension path set? -->
                        <property name="extension.path" value="${project.${extension}.path}"/>

                        <if>
                            <contains string="${extension.path}" substring="${"/>
                            <then>
                                <fail message="Missed related extension path property: project.${extension}.path"/>
                            </then>
                        </if>

                        <!-- Make sure we have the main extensions folder -->
                        <if>
                            <not>
                                <available file="${extensions.tmp.path}" type="dir" />
                            </not>
                            <then>
                                <mkdir dir="${extensions.tmp.path}"/>
                            </then>
                        </if>

                        <!-- Run the related extension phing script -->
                        <mkdir dir="${extensions.tmp.path}/${extension}"/>
                        <exec command="phing -f ${extension.path}/build.xml build -Dpackages.tmp.path=${extensions.tmp.path}/${extension} -DignoreRelatedExtensions=${project.relatedExtensions} -logger phing.listener.DefaultLogger" logoutput="true" checkreturn="true"/>
                    </else>
                </if>
            </then>
        </if>
    </target>

    <!-- Pack the includes into a project -->
    <target name="pack-includes">
        <if>
            <not>
                <contains string="${include}" substring="${"/>
            </not>
            <then>
                <echo>Packing the include: ${include}</echo>

                <!-- Is the include path set? -->
                <property name="include.path" value="${project.${include}.path}"/>

                <if>
                    <contains string="${include.path}" substring="${"/>
                    <then>
                        <fail message="Missed include path property: project.${include}.path"/>
                    </then>
                </if>

                <!-- Check if we have a custom source for this include. If not, use src/ -->
                <if>
                    <contains string="${project.includes.${include}.source}" substring="${"/>
                    <then>
                        <property name="project.includes.${include}.source" value="src/" override="true" />
                    </then>
                </if>

                <!-- Check if we have a custom destination for this include -->
                <if>
                    <contains string="${project.includes.${include}.destination}" substring="${"/>
                    <then>
                        <property name="project.includes.${include}.destination" value="" override="true" />
                    </then>
                </if>

                <!-- Run the include phing script -->
                <exec command="phing -f ${include.path}/build.xml copy -Dpackages.tmp.path=${packages.tmp.path}/${project.includes.${include}.destination} -logger phing.listener.DefaultLogger -Dproject.type=${project.type} -Dinclude.source=${project.includes.${include}.source}" logoutput="true" checkreturn="true"/>
            </then>
        </if>
    </target>

    <!-- Create Package without identifying version info -->
    <target name="package">
        <property name="package.path" value="${packages.path}/${package.file}"/>

        <!-- Remove the package, if exists -->
        <available file="${package.path}" property="package.path.exists" value="1"/>
        <if>
            <equals arg1="${package.path.exists}" arg2="1"/>
            <then>
                <delete file="${packages.path}/${package.file}"/>
            </then>
        </if>

        <!-- Prepare the packages temporary folders -->
        <if>
            <available file="${packages.tmp.path}" type="dir"/>
            <then>
                <delete dir="${packages.tmp.path}"/>
            </then>
        </if>
        <mkdir dir="${packages.tmp.path}"/>

        <!-- Copy the installer library, if there is a custom installer script -->
        <if>
            <isset property="manifest.scriptfile"/>
            <then>
                <!-- Check if the installer library path is set -->
                <if>
                    <contains string="${project.AllediaInstaller.path}" substring="${"/>
                    <then>
                        <fail message="Missed the project.AllediaInstaller.path property"/>
                    </then>
                </if>

                <property name="installer.source.path" value="${project.AllediaInstaller.path}/src"/>

                <if>
                    <equals arg1="${composer.type}" arg2="joomla.component"/>
                    <then>
                        <property name="installer.tmp.path" value="${packages.tmp.path}/admin"/>
                    </then>
                    <else>
                        <property name="installer.tmp.path" value="${packages.tmp.path}"/>
                    </else>
                </if>

                <copy todir="${installer.tmp.path}">
                    <fileset dir="${installer.source.path}" id="installer-code">
                        <include name="**"/>
                        <exclude name="media/**"/>
                    </fileset>
                </copy>

                <!-- Installer media - it is separated because componentes use admin/site subfolders folders -->
                <copy todir="${packages.tmp.path}/media">
                    <fileset dir="${installer.source.path}/media" id="installer-media-code">
                        <include name="**"/>
                    </fileset>
                </copy>
            </then>
        </if>

        <!-- Copy the resources specified by the include tag -->
        <if>
            <istrue value="${capabilities.parallel}"/>
            <then>
                <foreach_parallel list="${project.includes}" param="include" target="pack-includes" delimiter="," threadCount="${builder.thread.count}" />
            </then>
            <else>
                <foreach list="${project.includes}" param="include" target="pack-includes" delimiter="," />
            </else>
        </if>

        <!-- Copy the free source folder to a temporary location -->
        <if>
           <equals arg1="${project.hasFreeVersion}" arg2="1"/>
           <then>
                <copy todir="${packages.tmp.path}" overwrite="true">
                    <fileset dir="${project.free.source.path}" id="free-code">
                        <include name="**"/>
                    </fileset>
                </copy>
           </then>
        </if>

        <!-- Pro extensions -->
        <if>
            <equals arg1="${composer.extra.package-license}" arg2="pro"/>
            <then>

                <!-- Copy the pro source overriding the existent free code -->
                <copy todir="${packages.tmp.path}" overwrite="true">
                    <fileset dir="${project.source.path}" id="pro-code">
                        <include name="**"/>
                    </fileset>
                </copy>

                <!-- Merge language files -->
                <if>
                    <equals arg1="${composer.type}" arg2="joomla.component"/>
                    <then>
                        <if>
                            <available file="${packages.tmp.path}/admin/language/en-GB" type="dir" />
                            <then>
                                <mergefiles basepath="${packages.tmp.path}/admin/language/en-GB" pattern=".pro." replace="."/>
                            </then>
                        </if>

                        <if>
                            <available file="${packages.tmp.path}/site/language/en-GB" type="dir" />
                            <then>
                                <mergefiles basepath="${packages.tmp.path}/site/language/en-GB" pattern=".pro." replace="."/>
                            </then>
                        </if>
                    </then>
                    <else>
                        <mergefiles basepath="${packages.tmp.path}/language/en-GB" pattern=".pro." replace="."/>
                    </else>
                </if>
            </then>
        </if>

        <!-- Pack related extensions -->
        <if>
            <istrue value="${capabilities.parallel}"/>
            <then>
                <foreach_parallel list="${project.relatedExtensions}" param="extension" target="pack-related-extensions" delimiter="," threadCount="${builder.thread.count}" />
            </then>
            <else>
                <foreach list="${project.relatedExtensions}" param="extension" target="pack-related-extensions" delimiter="," />
            </else>
        </if>

        <!-- PHP Lint -->
        <property name="project.phplint" value="1" override="false"/>
        <if>
            <equals arg1="${project.phplint}" arg2="1"/>
            <then>
                <phplint haltonfailure="true">
                    <fileset dir="${packages.tmp.path}">
                        <include name="**/*.php"/>
                    </fileset>
                </phplint>
            </then>
        </if>

        <if>
            <equals arg1="${buildingdirectly}" arg2="1"/>
            <then>
                <!-- Pack the tmp folder -->
                <zip destfile="${packages.path}/${package.file}" includeemptydirs="true" basedir="${packages.tmp.path}"/>

                <!-- Check if we want to move the new package to a new destination -->
                <if>
                    <equals arg1="${project.movePackage}" arg2="1"/>
                    <then>
                        <echo>Moving package...</echo>
                        <move file="${packages.path}/${package.file}" tofile="${project.movePackageTo}/${package.file}" overwrite="true" />
                    </then>
                </if>

                <!-- Remove tmp folder -->
                <if>
                    <not>
                        <equals arg1="${debug}" arg2="1"/>
                    </not>
                    <then>
                        <delete dir="${packages.tmp.path}"/>
                    </then>
                </if>
            </then>
        </if>

        <!-- Show what are the branches are being used for each sub project -->
        <if>
            <equals arg1="${buildingdirectly}" arg2="1" />
            <then>
                <if>
                    <equals arg1="${composer.extra.package-license}" arg2="pro"/>
                    <then>
                        <property name="projects" value="AllediaBuilder,${composer.extra.name},${composer.extra.name}-Pro" override="true"/>
                        <property name="project.${composer.extra.name}-Pro.path" value="${project.path}" />
                    </then>
                    <else>
                        <property name="projects" value="AllediaBuilder,${composer.extra.name}" override="true"/>
                        <property name="project.${composer.extra.name}.path" value="${project.path}" />
                    </else>
                </if>
                <!-- Inject the installer on the projects property, if needed -->
                <if>
                    <isset property="manifest.scriptfile"/>
                    <then>
                        <property name="projects" value="AllediaInstaller,${projects}" override="true"/>
                    </then>
                </if>

                <property name="project.AllediaBuilder.path" value="${builder.path}" />

                <phingcall target="show-branches">
                    <property name="projects" value="${projects},${project.relatedExtensions},${project.includes}" />
                </phingcall>

                <echo>Version: ${manifest.version}</echo>
            </then>
        </if>

    </target>

    <!-- Update creation date in Joomla manifest file -->
    <target name="update-creation">
        <tstamp prefix="creation"/>

        <property name="creation.find" value=""><![CDATA[<creationDate>.*</creationDate>]]></property>
        <property name="creation.replace" value=""><![CDATA[<creationDate>${creation.TODAY}</creationDate>]]></property>
        <reflexive file="${project.manifest}">
            <filterchain>
                <replaceregexp>
                    <!--suppress PhingDomInspection -->
                    <regexp pattern="${creation.find}" replace="${creation.replace}"/>
                </replaceregexp>
            </filterchain>
        </reflexive>
        <echo message="Creation Date: ${creation.TODAY}"/>
    </target>

    <target name="prompt-new-version" hidden="true">
        <echo><![CDATA[
            Current version: ${manifest.version}

            New version level:

            1. Major
            2. Minor
            3. Bugfix
            4. Alpha
            5. Beta
            6. RC
            7. Custom
        ]]></echo>
        <input
            propertyName="release.id"
            validArgs="1, 2, 3, 4, 5, 6, 7"
            message="Release Type: "/>

        <if>
            <equals arg1="${release.id}" arg2="1"/>
            <then>
                <property name="release.type" value="major"/>
            </then>
            <elseif>
                <equals arg1="${release.id}" arg2="2"/>
                <then>
                    <property name="release.type" value="minor"/>
                </then>
            </elseif>
            <elseif>
                <equals arg1="${release.id}" arg2="3"/>
                <then>
                    <property name="release.type" value="bugfix"/>
                </then>
            </elseif>
            <elseif>
                <equals arg1="${release.id}" arg2="4"/>
                <then>
                    <property name="release.type" value="a"/>
                    <phingcall target="prompt-new-dev-version"/>
                </then>
            </elseif>
            <elseif>
                <equals arg1="${release.id}" arg2="5"/>
                <then>
                    <property name="release.type" value="b"/>
                    <phingcall target="prompt-new-dev-version"/>
                </then>
            </elseif>
            <elseif>
                <equals arg1="${release.id}" arg2="6"/>
                <then>
                    <property name="release.type" value="rc"/>
                    <phingcall target="prompt-new-dev-version"/>
                </then>
            </elseif>
            <elseif>
                <equals arg1="${release.id}" arg2="7"/>
                <then>
                    <property name="release.type" value="custom"/>
                    <input
                        propertyName="release.custom_version"
                        defaultValue="${manifest.version}"
                        message="Custom version: "/>
                </then>
            </elseif>
        </if>
    </target>

    <target name="prompt-new-dev-version" hidden="true">
        <echo><![CDATA[
            Next version:

            1. Major
            2. Minor
            3. Bugfix

            0. Keep current base version
        ]]></echo>
        <input
            propertyName="release.id"
            validArgs="1, 2, 3, 7, 0"
            message="Release Type: "/>

        <if>
            <equals arg1="${release.id}" arg2="1"/>
            <then>
                <property name="new.release.type" value="major"/>
            </then>
            <elseif>
                <equals arg1="${release.id}" arg2="2"/>
                <then>
                    <property name="new.release.type" value="minor"/>
                </then>
            </elseif>
            <elseif>
                <equals arg1="${release.id}" arg2="3"/>
                <then>
                    <property name="new.release.type" value="bugfix"/>
                </then>
            </elseif>
        </if>

        <if>
            <not>
                <equals arg1="${release.id}" arg2="0"/>
            </not>
            <then>
                <setversion releasetype="${new.release.type}" file="${project.manifest}" property="manifest.version" customvalue="${new.release.custom_version}"/>
                <phingcall target="update-creation"/>

                <!-- Update the version for related extensions which are not on this repo, but still set to update -->
                <foreach list="${project.relatedExtensions}" param="extension" target="set-version-related-extensions" delimiter="," />
            </then>
        </if>

    </target>

    <target name="show-branches">
        <showbranches projects="${projects}"/>
    </target>
</project>
