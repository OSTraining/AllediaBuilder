<?xml version="1.0" encoding="UTF-8"?>
<project name="Tester" default="test">
    <!-- TODO: Split tests into groups and run them in parallel. Keep the install extension test in a group and commit the container to reuse in the next tests
     http://codeception.com/docs/07-AdvancedUsage#Groups, http://codeception.com/docs/12-ParallelExecution#Step-1-Split-Tests -->
    <property name="memory" value="512MB" />

    <target name="test">
        <!-- Build a package to be tested -->
        <property name="package.file" value="${project.name.long}_${composer.extra.package-license}_${manifest.version}.zip"/>
        <phingcall target="build" />

        <!-- Move the built file to the _data folder -->
        <echo>Moving the built package to the _data folder to be installed</echo>
        <copy file="${packages.path}/${package.file}" tofile="${project.path}/tests/_output/extension_installer.zip" />
        <delete dir="${project.path}/tests/_output/extension_installer" quiet="true" />
        <unzip file="${project.path}/tests/_output/extension_installer.zip" todir="${project.path}/tests/_output/extension_installer" />

        <parallel threadCount="2">
            <phingcall target="test-in-joomla">
                <property name="joomla.version" value="25" />
            </phingcall>

            <phingcall target="test-in-joomla">
                <property name="joomla.version" value="34" />
            </phingcall>
        </parallel>

        <!-- Show tests result warning for Joomla 25 -->
        <if>
            <available file="${project.path}/tests/_output/j25.success" />
            <then>
                <echo level="warning">Results for j25: Good Job! :)  Your tests passed successfully!</echo>
            </then>
            <else>
                <echo level="error">Results for j25: Oh man :(  I have detected errors or failed tests: tests/_output/report_joomla25.html</echo>
            </else>
        </if>

        <!-- Show tests result warning for Joomla 34 -->
        <if>
            <available file="${project.path}/tests/_output/j34.success" />
            <then>
                <echo level="warning">Results for j34: Good Job! :)  Your tests passed successfully!</echo>
            </then>
            <else>
                <echo level="error">Results for j34: Oh man :(  I have detected errors or failed tests: tests/_output/report_joomla34.html</echo>
            </else>
        </if>
    </target>

    <target name="test-in-joomla">
        <property name="line.prefix" value="j${joomla.version} :::" />
        <property name="success.file" value="${project.path}/tests/_output/j${joomla.version}.success" />
        <if>
            <equals arg1="${test.container.joomla${joomla.version}}" arg2="1"/>
            <then>
                <!-- Load a docker container from alledia/joomlaXXtests to run the tests -->
                <property name="container.name" value="allediabuilder_${project.name.long}_j${joomla.version}_tests" />
                <trycatch property="catchOutput">
                    <try>
                        <echo>${line.prefix} Wait... preparing the test environment for j${joomla.version}</echo>
                        <delete file="${success.file}" quiet="true" />
                        <echo level="debug">${line.prefix} Cleanup existent containers...</echo>
                        <exec command="docker rm -f ${container.name}" />
                        <exec command="docker run -m ${memory} -d --name ${container.name} -p ::80 -p ::4444 -v ${project.path}:/project -v ${builder.path}:/builder -v ${project.path}/tests/_output/run/j${joomla.version}_mysqld:/run/mysqld alledia/joomla-codeception:joomla${joomla.version}" outputProperty="container.id" returnProperty="container.result" checkreturn="true" />

                        <echo level="debug">${line.prefix} Started a new container tests: ${container.name} (${container.id})</echo>

                        <!-- Delay of 10s waiting for MySQL to be ready - TODO: Change for a real service status checker -->
                        <echo level="debug">${line.prefix} Waiting for the MySQL to be ready...</echo>

                        <!-- Wait for MySQL to be ready -->
                        <waitfor maxwaitunit="second" maxwait="20">
                            <available file="${project.path}/tests/_output/run/j${joomla.version}_mysqld/mysqld.pid" />
                        </waitfor>

                        <!-- Install the package into the container running a test -->
                        <echo>${line.prefix} Hold on, running the extension's tests in j${joomla.version}...</echo>

                        <exec command="docker exec ${container.name} codecept run ${params} --no-colors --html /project/tests/_output/report_joomla${joomla.version}.html -c /project" returnProperty="tests.result" outputProperty="tests.output" checkreturn="true" />

                        <echo level="debug">${line.prefix} ${tests.output}</echo>
                        <echo file="${success.file}">1</echo>
                    </try>
                    <catch>
                        <!-- Error/Exception found -->
                        <echo level="error">${line.prefix} Error/failure: ${line.separator}${catchOutput}${line.separator}${line.separator}Command: ${line.separator}Output: ${tests.output}</echo>
                    </catch>
                    <finally>
                        <!-- Stop and remove the containers -->
                        <echo level="debug">${line.prefix} Removing the container ${container.id}</echo>
                        <exec command="docker rm -f ${container.id}" />
                        <delete dir="${project.path}/tests/_output/run/j${joomla.version}_mysqld" quiet="true" />
                    </finally>
                </trycatch>
            </then>
        </if>
    </target>

    <target name="test-bootstrap">
        <!-- Check if we already are bootstrapped -->
        <condition property="bootstrapped-already">
            <or>
                <available file="${project.path}/codeception.yml" property="codeception.yml.available" />
                <available file="${project.path}/tests" property="codeception.tests.available" />
            </or>
        </condition>
        <if>
            <equals arg1="${bootstrapped-already}" arg2="true" />
            <then>
                <echo level="warning">It seems like your project already have the tests set up.</echo>
                <echo level="info">If you would like to bootstrap it again, please remove:${line.separator}${line.separator}                ./tests${line.separator}                ./codeception.yml</echo>
            </then>
            <else>
                <trycatch property="catchOutputBootstrap">
                    <try>
                        <!-- Run the Codeception bootstrap -->
                        <exec command="docker run -d -v ${project.path}:/project -m ${memory} alledia/codeception" returnProperty="container.result" outputProperty="container.id" />
                        <exec command="docker exec ${container.id} codecept bootstrap /project" outputProperty="container.output" />

                        <!-- Check the basic files -->
                        <condition property="bootstrapped">
                            <and>
                                <available file="${project.path}/codeception.yml" property="codeception.yml.available" />
                                <available file="${project.path}/tests" property="codeception.tests.available" />
                            </and>
                        </condition>
                        <if>
                            <equals arg1="${bootstrapped}" arg2="true" />
                            <then>
                                <echo>Codeception is bootstrapped successfully</echo>
                                <!-- Check the build.properties file -->
                                <echo>Checking build.properties file for Joomla 2.5 and Joomla 3.4 support properties</echo>
                                <if>
                                    <contains string="${test.container.joomla25}" substring="${" />
                                    <then>
                                        <echo file="${project.path}/build.properties" append="true">${line.separator}test.container.joomla25=1</echo>
                                    </then>
                                </if>
                                <if>
                                    <contains string="${test.container.joomla34}" substring="${" />
                                    <then>
                                        <echo file="${project.path}/build.properties" append="true">${line.separator}test.container.joomla34=1</echo>
                                    </then>
                                </if>

                                <!-- Creates the acceptance.suite.yml file-->
                                <echo>Creating the default acceptance.suite.yml file</echo>
                                <echo file="${project.path}/tests/acceptance.suite.yml"><![CDATA[# Codeception Test Suite Configuration
# suite for acceptance tests.
# perform tests in browser using the WebDriver or PhpBrowser.
# If you need both WebDriver and PHPBrowser tests - create a separate suite.

class_name: AcceptanceTester
modules:
    enabled:
        - WebDriver
        - AcceptanceHelper
    config:
        WebDriver:
            url: 'http://127.0.0.1'
            browser: phantomjs
            host: localhost
            port: 4444
            window_size: 1200x768
            wait: 10
            restart: true
            capabilities:
                webStorageEnabled: true
                takesScreenshot: true
                cssSelectorsEnabled: true]]></echo>

                                <!-- Fill the bootstrap file -->
                                <echo>Creating the default _bootstrap.php file, inheriting from AllediaBuilder</echo>
                                <echo file="${project.path}/tests/_bootstrap.php" append="true">${line.separator}// Load the bootstrap file from Alledia Builder${line.separator}require_once '/builder/src/codeception/_bootstrap.php';</echo>

                                <!-- Create the installer acceptance test -->
                                <echo file="${project.path}/tests/acceptance/AAAExtensionInstallerCest.php"><![CDATA[<?php
use \AcceptanceTester;

require_once ALLEDIA_BUILDER_PATH . '/src/codeception/acceptance/ExtensionInstallerAbstractCest.php';

class AAAExtensionInstallerCest extends ExtensionInstallerAbstractCest
{

}
]]></echo>
                                <echo>Tests bootstrapped successfully!</echo>
                            </then>
                            <else>
                                <echo level="error">Error: ${container.output}</echo>
                            </else>
                        </if>
                    </try>
                    <catch>
                        <echo level="error">${catchOutputBootstrap}</echo>
                    </catch>
                    <finally>
                        <exec command="docker rm ${container.id}" />
                    </finally>
                </trycatch>
            </else>
        </if>
    </target>

    <target name="test-cleanup">
        <echo>Removing the docker containers, if found</echo>
        <exec command="docker rm -f allediabuilder_${project.name.long}_j25_tests" />
        <exec command="docker rm -f allediabuilder_${project.name.long}_j34_tests" />

        <echo>Cleaning the _output folder</echo>
        <delete quiet="true" includeemptydirs="true">
            <fileset dir="${project.path}/tests/_output">
                <include name="**" />
            </fileset>
        </delete>
        <mkdir dir="${project.path}/tests/_output" />
    </target>
</project>
