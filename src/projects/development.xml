<?xml version="1.0" encoding="UTF-8"?>
<project name="Development" default="build">
    <!-- Create a temporary merged language file for local development with symlink -->
    <target name="merge-language-dev" description="Create merged language files">
        <if>
            <equals arg1="${composer.type}" arg2="joomla.component"/>
            <then>
                <!-- Admin -->
                <phingcall target="merge-language-dev-subtask">
                    <property name="language.tmp.path" value="${packages.path}/dev/admin/language/en-GB"/>
                    <property name="language.free.path" value="${project.free.source.path}/admin/language/en-GB"/>
                    <property name="language.pro.path" value="${project.source.path}/admin/language/en-GB"/>
                </phingcall>

                <!-- Site -->
                <phingcall target="merge-language-dev-subtask">
                    <property name="language.tmp.path" value="${packages.path}/dev/site/language/en-GB"/>
                    <property name="language.free.path" value="${project.free.source.path}/site/language/en-GB"/>
                    <property name="language.pro.path" value="${project.source.path}/site/language/en-GB"/>
                </phingcall>
            </then>
            <else>
                <phingcall target="merge-language-dev-subtask">
                    <property name="language.tmp.path" value="${packages.path}/dev/language/en-GB"/>
                    <property name="language.free.path" value="${project.free.source.path}/language/en-GB"/>
                    <property name="language.pro.path" value="${project.source.path}/language/en-GB"/>
                </phingcall>
            </else>
        </if>
    </target>

    <target name="merge-language-dev-subtask">
        <if>
            <available file="${language.free.path}" type="dir"/>
            <then>
                <!-- Prepare the temporary folder for language -->
                <if>
                    <available file="${language.tmp.path}" type="dir"/>
                    <then>
                        <delete dir="${language.tmp.path}"/>
                    </then>
                </if>
                <mkdir dir="${language.tmp.path}"/>

                <!-- Copy the free source folder to a temporary location -->
                <copy todir="${language.tmp.path}">
                    <fileset dir="${language.free.path}" id="free-code">
                        <include name="*.ini"/>
                    </fileset>
                </copy>

                <!-- Pro extensions -->
                <if>
                    <equals arg1="${composer.extra.package-license}" arg2="pro"/>
                    <then>

                        <!-- Copy the pro source overriding the existent free code -->
                        <copy todir="${language.tmp.path}" overwrite="true">
                            <fileset dir="${language.pro.path}" id="pro-code">
                                <include name="*.ini"/>
                            </fileset>
                        </copy>

                        <!-- Merge language files -->
                        <mergefiles basepath="${language.tmp.path}" pattern=".pro." replace="."/>

                        <echo message="Language files merged"/>
                    </then>
                </if>
            </then>
        </if>
    </target>

    <target name="cs-fix" description="Run php-cs-fixer on the ./src dir">
        <!-- Check if we have a custom config file, if not, run the default fixers -->
        <if>
            <available file=".php_cs" type="file"/>
            <then>
                <echo message="Please, wait... fixing the code (based on custom config file: .php_cs)" />
                <exec command="${builder.vendor.bin.path}/php-cs-fixer fix" escape="false" outputProperty="cmd.output" />
            </then>
            <else>
                <echo message="Please, wait... fixing the code (based on default command)" />
                <exec command="${builder.vendor.bin.path}/php-cs-fixer fix --fixers=align_equals,encoding,concat_with_spaces,-psr0 --level=psr2 ." dir="./src" escape="false" outputProperty="cmd.output" />
            </else>
        </if>

        <echo message="${cmd.output}" />
    </target>

</project>
