<?xml version="1.0" encoding="UTF-8"?>
<project name="Development" default="build">
    <taskdef name="createsymlinks" classname="CreateSymlinksTask" />
    <taskdef name="unlinksynlinks" classname="UnlinkSymlinksTask" />

    <property name="symlink.map.path" value="${project.path}/symlinks.yml"/>

    <!-- Create a temporary merged language file for local development with symlink -->
    <target name="merge-language-dev" description="Create merged language files">
        <if>
            <equals arg1="${composer.type}" arg2="joomla.component"/>
            <then>
                <!-- Admin -->
                <phingcall target="merge-language-dev-subtask">
                    <property name="language.tmp.path" value="${packages.path}/dev/admin/language/en-GB"/>
                    <property name="language.free.path" value="${project.free.source.path}/admin/language/en-GB"/>
                    <property name="language.pro.path" value="${project.source.path}/admin/language/en-GB"/>
                </phingcall>

                <!-- Site -->
                <phingcall target="merge-language-dev-subtask">
                    <property name="language.tmp.path" value="${packages.path}/dev/site/language/en-GB"/>
                    <property name="language.free.path" value="${project.free.source.path}/site/language/en-GB"/>
                    <property name="language.pro.path" value="${project.source.path}/site/language/en-GB"/>
                </phingcall>
            </then>
            <else>
                <phingcall target="merge-language-dev-subtask">
                    <property name="language.tmp.path" value="${packages.path}/dev/language/en-GB"/>
                    <property name="language.free.path" value="${project.free.source.path}/language/en-GB"/>
                    <property name="language.pro.path" value="${project.source.path}/language/en-GB"/>
                </phingcall>
            </else>
        </if>
    </target>

    <target name="merge-language-dev-subtask">
        <if>
            <available file="${language.free.path}" type="dir"/>
            <then>
                <!-- Prepare the temporary folder for language -->
                <if>
                    <available file="${language.tmp.path}" type="dir"/>
                    <then>
                        <delete dir="${language.tmp.path}"/>
                    </then>
                </if>
                <mkdir dir="${language.tmp.path}"/>

                <!-- Copy the free source folder to a temporary location -->
                <copy todir="${language.tmp.path}">
                    <fileset dir="${language.free.path}" id="free-code">
                        <include name="*.ini"/>
                    </fileset>
                </copy>

                <!-- Pro extensions -->
                <if>
                    <equals arg1="${composer.extra.package-license}" arg2="pro"/>
                    <then>

                        <!-- Copy the pro source overriding the existent free code -->
                        <copy todir="${language.tmp.path}" overwrite="true">
                            <fileset dir="${language.pro.path}" id="pro-code">
                                <include name="*.ini"/>
                            </fileset>
                        </copy>

                        <!-- Merge language files -->
                        <mergefiles basepath="${language.tmp.path}" pattern=".pro." replace="."/>

                        <echo message="Language files merged"/>
                    </then>
                </if>
            </then>
        </if>
    </target>

    <!-- Create symlinks for the extension in development environments -->
    <target name="symlink">
        <phingcall target="merge-language-dev" />

        <if>
            <available file="${packages.path}/.build.properties"/>
            <then>
                <property file="${packages.path}/.build.properties" />
            </then>
            <else>
                <property name="joomla.path" value="" override="true" />
            </else>
        </if>
        <input propertyName="joomla.path" message="Joomla root path: " defaultValue="${joomla.path}"/>

        <createsymlinks mapfile="${symlink.map.path}" destinationbasepath="${joomla.path}" sourcebasepath="${project.path}"/>

        <!-- Stores the last symlinked path -->
        <if>
            <os family="unix"/>
            <then>
                <exec command="echo 'joomla.path=${joomla.path}' > ${packages.path}/.build.properties"/>
            </then>
        </if>
    </target>

    <!-- Remove symlinks for the extension in development environments -->
    <target name="unlink">
        <if>
            <available file="${packages.path}/.build.properties"/>
            <then>
                <property file="${packages.path}/.build.properties" />
            </then>
            <else>
                <property name="joomla.path" value="" override="true" />
            </else>
        </if>
        <input propertyName="joomla.path" message="Joomla root path: " defaultValue="${joomla.path}"/>

        <unlinksynlinks mapfile="${symlink.map.path}" destinationbasepath="${joomla.path}" sourcebasepath="${project.path}"/>
    </target>

</project>
